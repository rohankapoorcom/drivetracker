{% extends "base.html" %}
{% load staticfiles %}
{% block head %}
<title>Test</title>
<link href="{% static 'css/dashboard.css' %}" rel="stylesheet">
<link href="{% static 'css/datatables.min.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12 col-md-12 main">

      <div class="row placeholders">
        <div class="col-xs-6 col-sm-3 placeholder">
          <div id="manufacturer-graph" class="chart">
          </div>
          <h4>Manufacturers</h4>
        </div>
        <div class="col-xs-6 col-sm-3 placeholder">
          <div id="capacity-graph" class="chart">
          </div>
          <h4>Capacity</h4>
        </div>
        <div class="col-xs-6 col-sm-3 placeholder">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAHd3dwAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" width="200" height="200" class="img-responsive" alt="Generic placeholder thumbnail">
          <h4>Label</h4>
          <span class="text-muted">Something else</span>
        </div>
        <div class="col-xs-6 col-sm-3 placeholder">
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAHd3dwAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" width="200" height="200" class="img-responsive" alt="Generic placeholder thumbnail">
          <h4>Label</h4>
          <span class="text-muted">Something else</span>
        </div>
      </div>

      <h2 class="sub-header">Section title</h2>
        <table class="table table-striped display responsive nowrap" id="drive-table" width="100%">
          <thead>
            <tr>
              <th data-priority="1">ID</th>
              <th>Host</th>
              <th data-priority="2">Serial</th>
              <th>Type</th>
              <th>In Use?</th>
              <th>Status</th>
              <th data-priority="3">Manufacturer's</th>
              <th>Model</th>
              <th>Capacity</th>
              <th>Interface</th>
              <th>RPM</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      <!-- </div> -->
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/datatables.min.js' %}"></script>
<script>
$(document).ready(function() {
  $('#drive-table').DataTable( {
    "ajax": {
      url: "{% url 'api_drives_list' %}",
      dataSrc: ''
    },
    "columns": [
      {"data": "id"},
      {"data": "host"},
      {"data": "serial"},
      {"data": "media_type"},
      {"data": "in_use"},
      {"data": "status"},
      {"data": "manufacturer"},
      {"data": "model"},
      {"data": "capacity"},
      {"data": "interface"},
      {"data": "rpm"}
    ]
  });

  $('#drive-table tbody').on('click', 'tr', function() {
    var table = $('#drive-table').DataTable();
    var data = table.row(this).data().id;
    console.log(data);
  });
  (function(d3) {
    'use strict';
    var width = 200,
      height = 200,
      radius = Math.min(width, height) / 2,
      donutWidth = 50,
      legendRectSize = 18,
      legendSpacing = 4,
      color = d3.scale.category20();

    /* Common graphing variables */
    var arc = d3.svg.arc()
      .innerRadius(radius - donutWidth)
      .outerRadius(radius);

    var pie = d3.layout.pie()
      .value(function(d) { return d.count; })
      .sort(null);

    /* Manufacturer's Graph */
    var manufacturersSvg = d3.select('#manufacturer-graph')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .append('g')
      .attr("transform", "translate(" + Math.min(width,height) / 2 + "," + Math.min(width,height) / 2 + ")");

    /* Capacity Graph */
    var capacitySvg = d3.select('#capacity-graph')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .append('g')
      .attr("transform", "translate(" + Math.min(width,height) / 2 + "," + Math.min(width,height) / 2 + ")");

    d3.json("{% url 'api_drives_list' %}?representation=original", function(error, dataset) {
      var manufacturers = {};
      var capacities = {};

      dataset.forEach(function(drive) {
        var manufacturer = drive.manufacturer;
        var in_use = drive.in_use == null || drive.in_use == false ? 'Available' : 'In Use';

        manufacturers[manufacturer] = manufacturers[manufacturer] ? manufacturers[manufacturer] + 1 : 1;
        capacities[in_use] = capacities[in_use] ? capacities[in_use] + drive.capacity : drive.capacity;
      });

      manufacturers = $.map(manufacturers, function(value, index) {
        return [{"label": index, "count": value}];
      });
      capacities = $.map(capacities, function(value, index) {
        return [{"label": index, "count": value}]
      })

      /* Draw the graph for the Manufacturer's Graph */
      var manufacturersPath = manufacturersSvg.selectAll('path')
        .data(pie(manufacturers))
        .enter()
        .append('path')
        .attr('d', arc)
        .attr('fill', function(d, i) {
          return color(d.data.label);
        });

      /* Add tooltips to the Manufacturer's Graph */
      manufacturersPath.each(function(d,i) {
        var total = d3.sum(manufacturers.map(function(d) {
          return d.count;
        }));
        var percent = Math.round(1000 * d.data.count / total) / 10;
        var popover = $(manufacturersPath[0][i]).popover({
          'container': 'body',
          'title': d.data.label,
          'content': percent + '% of ' + total + ' drives',
          'trigger': 'hover focus'
        });
      })

      /* Draw the graph for the Capacity Graph */
      var capacity_path = capacitySvg.selectAll('path')
        .data(pie(capacities))
        .enter()
        .append('path')
        .attr('d', arc)
        .attr('fill', function(d, i) {
          return color(d.data.label);
        });

      /* Add tooltips to the Capacity Graph */
      capacity_path.each(function(d,i) {
        var total = d3.sum(capacities.map(function(d) {
          return d.count;
        }));
        var percent = Math.round(1000 * d.data.count / total) / 10;
        var popover = $(capacity_path[0][i]).popover({
          'container': 'body',
          'title': d.data.label,
          'content': percent + '% of ' + formatBytes(total),
          'trigger': 'hover focus'
        });
      })

    });
  })(window.d3);
});

</script>
{% endblock %}
